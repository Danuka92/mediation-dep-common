<?xml version="1.0" encoding="UTF-8"?>
<template
    name="com.wso2telco.dep.common.main.response.datapublisher.Template" xmlns="http://ws.apache.org/ns/synapse">
    <parameter name="msisdn"/>
    <parameter name="direction"/>
    <sequence>
        <property expression="fn:concat($func:direction,' response')"
            name="DIRECTION" xmlns:ns="http://org.apache.synapse/xsd" xmlns:ns2="http://org.apache.synapse/xsd"/>
        <property
            expression="get-property('registry', 'conf:/repository/wso2telco/configurations/mediationConfig.xml')"
            name="mediationConfig" scope="default" type="OM"
            xmlns:ns="http://org.apache.synapse/xsd" xmlns:ns2="http://org.apache.synapse/xsd"/>
        <property expression="$ctx:mediationConfig//data_publishing"
            name="dataPublishing" scope="default" type="STRING"
            xmlns:ns="http://org.apache.synapse/xsd" xmlns:ns2="http://org.apache.synapse/xsd"/>
        <filter regex="^(?i)(none|log|agent|hybrid)$"
            source="$ctx:dataPublishing"
            xmlns:ns="http://org.apache.synapse/xsd" xmlns:ns2="http://org.apache.synapse/xsd">
            <then/>
            <else>
                <property name="dataPublishing" scope="default"
                    type="STRING" value="none"/>
            </else>
        </filter>
        <filter regex="^(?i)(log|hybrid)$" source="$ctx:dataPublishing"
            xmlns:ns="http://org.apache.synapse/xsd" xmlns:ns2="http://org.apache.synapse/xsd">
            <then>
                <log level="custom">
                    <property name="STATUS" value="log response data"/>
                </log>
                <property
                    expression="synapse:get-property('SYSTEM_TIME')"
                    name="RESPONSE_TIME" scope="default" type="STRING"/>
                <class name="com.wso2telco.logging.PropertyLogHandlerESB"/>
            </then>
        </filter>
	 
        <filter regex="^(?i)(agent|hybrid)$" source="$ctx:dataPublishing"
            xmlns:ns="http://org.apache.synapse/xsd" xmlns:ns2="http://org.apache.synapse/xsd">
            <then>
                <log level="custom">
                    <property name="STATUS" value="publishing response data"/>
                    <property
                        expression="fn:concat($func:direction,' response')" name="DIRECTION"/>
                </log>
                <class name="org.wso2telco.dep.nashornmediator.NashornMediator">
                    <axis2ns4:property name="script"
                        value="       var contextVersion = mc.getProperty('API_VERSION');       var generated_api_version = contextVersion.replace(':', '_');       mc.setProperty('GENERATED_API_ID', generated_api_version);      " xmlns:axis2ns4="http://ws.apache.org/ns/synapse"/>
                </class>
                <property expression="$func:msisdn" name="msisdn"/>
                <property
                    expression="$ctx:mediationConfig//appendTokenHeader"
                    name="appendTokenHeader" scope="default" type="STRING"/>
                <filter regex="^(?i)(true)$" source="$ctx:appendTokenHeader">
                    <then>
                        <property
                            expression="$ctx:mediationConfig//tokenHeaderName"
                            name="tokenHeaderName" scope="default" type="STRING"/>
                        <class name="com.wso2telco.dep.common.mediation.HeaderAppendMediator"/>
                    </then>
                    <else/>
                </filter>
                <property
                    expression="synapse:get-property('SYSTEM_TIME')"
                    name="RESPONSE_TIME" scope="default" type="STRING"/>
                <property expression="json-eval($.)" name="JSON_BODY"
                    scope="default" type="STRING"/>
                <class name="org.wso2telco.dep.nashornmediator.NashornMediator">
                    <axis2ns5:property name="script"
                        value="       var diff = mc.getProperty('RESPONSE_TIME') - mc.getProperty('REQUEST_TIME');       mc.setProperty('SERVICE_TIME', diff);      " xmlns:axis2ns5="http://ws.apache.org/ns/synapse"/>
                </class>
                <filter xpath="boolean($ctx:sbAction)">
                    <then>
                        <property action="remove" name="sbAction"/>
                    </then>
                    <else/>
                </filter>
                <publishEvent>
                    <streamName>org.wso2telco.analytics.hub.stream.responseStatistics</streamName>
                    <streamVersion>1.0.0</streamVersion>
                    <eventSink>GatewayAnalyticsEvent</eventSink>
                    <attributes>
                        <meta>
                            <attribute defaultValue="" name="clientType"
                                type="STRING" value="NOT-REQUIRED"/>
                        </meta>
                        <correlation/>
                        <payload>
                            <attribute defaultValue=""
                                expression="$ctx:CONSUMER_KEY"
                                name="consumerKey" type="STRING"/>
                            <attribute defaultValue=""
                                expression="$ctx:CONTEXT" name="context" type="STRING"/>
                            <attribute defaultValue=""
                                expression="$ctx:VERSION"
                                name="apiVersion" type="STRING"/>
                            <attribute defaultValue=""
                                expression="$ctx:API_NAME" name="api" type="STRING"/>
                            <attribute defaultValue=""
                                expression="$ctx:RESOURCE"
                                name="resourcePath" type="STRING"/>
                            <attribute defaultValue=""
                                expression="$ctx:HTTP_METHOD"
                                name="method" type="STRING"/>
                            <attribute defaultValue=""
                                expression="$ctx:VERSION" name="version" type="STRING"/>
                            <attribute defaultValue=""
                                expression="$ctx:RESPONSE_TIME"
                                name="responseTime" type="LONG"/>
                            <attribute defaultValue=""
                                name="serviceTime" type="LONG" value="860"/>
                            <attribute defaultValue=""
                                expression="$ctx:USER_ID"
                                name="serviceProvider" type="STRING"/>
                            <attribute defaultValue=""
                                name="tenantDomain" type="STRING" value="carbon.super"/>
                            <attribute defaultValue=""
                                expression="$ctx:HOST_NAME"
                                name="hostName" type="STRING"/>
                            <attribute defaultValue=""
                                expression="$ctx:API_PUBLISHER"
                                name="apiPublisher" type="STRING"/>
                            <attribute defaultValue=""
                                expression="$ctx:APPLICATION_NAME"
                                name="applicationName" type="STRING"/>
                            <attribute defaultValue=""
                                expression="$ctx:REQUEST_ID"
                                name="requestId" type="STRING"/>
                            <attribute defaultValue=""
                                expression="$ctx:OPERATOR_ID"
                                name="operatorId" type="STRING"/>
                            <attribute defaultValue=""
                                expression="$axis2:HTTP_SC"
                                name="apiPublisher" type="STRING"/>
                            <attribute defaultValue=""
                                expression="fn:normalize-space($ctx:msisdn)"
                                name="msisdn" type="STRING"/>
                            <attribute defaultValue=""
                                expression="fn:normalize-space($func:direction)"
                                name="direction" type="STRING"/>
                            <attribute defaultValue=""
                                expression="$ctx:JSON_BODY"
                                name="jsonBody" type="STRING"/>
                            <attribute defaultValue=""
                                expression="$ctx:USER_ID"
                                name="serviceProviderId" type="STRING"/>
                            <attribute defaultValue=""
                                expression="$ctx:USER_ID"
                                name="spUserId" type="STRING"/>
                            <attribute defaultValue=""
                                expression="$ctx:CONSUMER_KEY"
                                name="spConsumerKey" type="STRING"/>
                            <attribute defaultValue=""
                                expression="$ctx:OPERATOR_NAME"
                                name="operatorName" type="STRING"/>
                            <attribute defaultValue=""
                                expression="$ctx:API_PUBLISHER"
                                name="apiPublisherID" type="STRING"/>
                            <attribute defaultValue=""
                                expression="$ctx:GENERATED_API_ID"
                                name="apiID" type="STRING"/>
                            <attribute defaultValue="" name="department"
                                type="STRING" value="NOT-REQUIRED"/>
                            <attribute defaultValue=""
                                expression="$ctx:APPLICATION_ID"
                                name="applicationId" type="STRING"/>
                        </payload>
                        <arbitrary/>
                    </attributes>
                </publishEvent>
            </then>
        </filter>
    </sequence>
</template>

